FR-CA 6HOUR COUNT BREACH NOTIFICATION

WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP) AS end_time
),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  TIME_FORMAT(__time, 'YYYY-MM-dd', 'America/Los_Angeles') AS order_date,
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    __time,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
  GROUP BY __time
) hourly_counts
GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd', 'America/Los_Angeles')
ORDER BY order_date;




WEEK 1
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
    --AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;


WEEK 2
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '2' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '2' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
   -- AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;

WEEK 3
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '3' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '3' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
    --AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;

WEEK 4
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '4' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '4' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
    --AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;

WEEK 5 
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '5' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '5' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
    --AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;


WEEK 6
WITH time_window AS (
  SELECT   
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '6' DAY - INTERVAL '6' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '6' DAY) AS end_time

),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod"
  CROSS JOIN time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'FR-CA'
),
joined_orders AS (
  SELECT   
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  SUM(order_count) AS total_order_count
FROM (
  SELECT
    TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
    COUNT(DISTINCT order_ref_id) AS order_count
  FROM joined_orders
  WHERE (action_0 IS NULL OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new'))
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
    --AND TIME_EXTRACT(__time, 'HOUR', 'America/Los_Angeles') NOT IN (0,1,2,3,20,21,22,23)
  GROUP BY TIME_FORMAT(__time, 'YYYY-MM-dd HH', 'America/Los_Angeles')
) hourly_counts;

