MCS EN-AU 1HOUR BREACH Alert

Current day count : 
WITH time_window AS (
  SELECT 
    DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR) AS start_time,
    DATE_TRUNC('hour', CURRENT_TIMESTAMP) AS end_time
),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod", time_window
  WHERE __time >= time_window.start_time
    AND __time < time_window.end_time
    AND UPPER(culture_code) = 'EN-AU'
    AND TIME_FORMAT(__time, 'HH', 'America/Los_Angeles') NOT IN ('05', '06', '07', '08', '10', '11', '12', '13', '14', '15')
),
joined_orders AS (
  SELECT 
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
)
SELECT
  TIME_FORMAT(FLOOR(__time TO HOUR), 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
  COALESCE(
    COUNT(DISTINCT CASE 
      WHEN (action_0 IS NULL) OR action_0 IN ('CREATE','RENEW','Renew','UPGRADE','UPSELL','DOWNGRADE','NEW','new')
           AND product_publisher_id = 'pse_operations_order'
           AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq','QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0','RHS9QkCwc5soOlrWhu21dKA2kxfCUCmw')
      THEN order_ref_id
    END), 0) AS order_count
FROM joined_orders
GROUP BY FLOOR(__time TO HOUR)
ORDER BY alert_hour DESC;


Average of 7 days :
WITH reference_hour AS (
  SELECT DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR) AS target_hour
),
t1 AS (
  SELECT
    __time,
    order_ref_id,
    order_status,
    payment_ref_id,
    culture_code,
    product_publisher_id,
    changed_by,
    "order_items.action_0" AS action_0
  FROM "pse-order-prod", reference_hour
  WHERE UPPER(culture_code) = 'EN-AU'
    AND TIME_FORMAT(__time, 'HH', 'America/Los_Angeles') = TIME_FORMAT(reference_hour.target_hour, 'HH', 'America/Los_Angeles')
    AND __time >= reference_hour.target_hour - INTERVAL '8' DAY
    AND __time < reference_hour.target_hour - INTERVAL '1' DAY  -- excludes today
    AND TIME_FORMAT(__time, 'HH', 'America/Los_Angeles') NOT IN ('05', '06', '07', '08', '10', '11', '12', '13', '14', '15' )
),
joined_orders AS (
  SELECT 
    f.__time,
    f.order_ref_id,
    i.action_0,
    f.product_publisher_id,
    f.changed_by
  FROM t1 f
  INNER JOIN t1 i
    ON f.order_ref_id = i.order_ref_id
   AND f.order_status = 'FULFILLED'
   AND f.payment_ref_id IS NOT NULL
   AND i.order_status = 'INITIATED'
),
filtered_orders AS (
  SELECT *
  FROM joined_orders
  WHERE action_0 IN ('CREATE', 'RENEW', 'Renew', 'UPGRADE', 'UPSELL', 'DOWNGRADE')
    AND product_publisher_id = 'pse_operations_order'
    AND changed_by IN ('zYS3jVFowmfobAJv8nxNfogpsky3djHq', 'QGF9qSQNUhWDHxZqWvTmGGgpXV5AUWh0')
)
SELECT
  ROUND(ABS(COUNT(DISTINCT order_ref_id) / 7.0 * 0.80)) AS avg_order_count_for_same_hour 
FROM filtered_orders;
