AR_1HOUR_ORDER_BREACH Alert

WITH sales AS (
  SELECT order_code 
  FROM "pse-order-prod"  
  WHERE __time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR)
    AND __time < DATE_TRUNC('hour', CURRENT_TIMESTAMP)
    AND order_status = 'FULFILLED'
),

ArOrders AS (
  SELECT  
    ar.order_code,
    FLOOR(ar.__time TO HOUR) AS order_hour,
    CASE
      WHEN ar.status_desc = 'OffLineOrders' AND s.order_code IS NOT NULL THEN 'Success'
      WHEN ar.status_desc = 'Success' THEN 'Success'
      ELSE 'Failure'
    END AS State
  FROM "autorenew_order_analytics-eventname_none-prod" ar
  LEFT JOIN sales s 
    ON ar.order_code = s.order_code
  WHERE ar.__time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR)
    AND ar.__time < DATE_TRUNC('hour', CURRENT_TIMESTAMP)
    AND ar.days_to_expiry <= 30
    AND CAST(TIME_FORMAT(ar.__time,'HH','America/Los_Angeles') AS int) IN (0,1,6,7,8,9,15)
)

SELECT
  TIME_FORMAT(order_hour, 'YYYY-MM-dd HH', 'America/Los_Angeles') AS alert_hour,
  COALESCE(COUNT(CASE WHEN State = 'Success' THEN 1 END), 0) AS current_hour_success_count
FROM ArOrders
GROUP BY order_hour
ORDER BY alert_hour DESC;


-- same hour 1 week before data
WITH sales_last_week AS (
  SELECT order_code FROM "pse-order-prod"
  WHERE __time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '7' DAY)
    AND __time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '7' DAY)
    AND order_status = 'FULFILLED'
),
ArOrders_last_week AS (
  SELECT ar.order_code,
    CASE
      WHEN ar.status_desc = 'OffLineOrders' AND s.order_code IS NOT NULL THEN 'Success'
      WHEN ar.status_desc = 'Success' THEN 'Success'
      ELSE 'Failure'
    END AS State
  FROM "autorenew_order_analytics-eventname_none-prod" ar
  LEFT JOIN sales_last_week s ON ar.order_code = s.order_code
  WHERE ar.__time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '7' DAY)
    AND ar.__time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '7' DAY)
    AND ar.days_to_expiry <= 30
    AND CAST(TIME_FORMAT(__time,'HH','America/Los_Angeles') AS int) IN (0,1,6,7,8,9,15)
)
SELECT
  COUNT(CASE WHEN State = 'Success' THEN 1 END) AS last_week_same_hour_success_count
FROM ArOrders_last_week;


-- same hour 2 week before data
WITH sales_last_week AS (
  SELECT order_code FROM "pse-order-prod"
  WHERE __time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '14' DAY)
    AND __time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '14' DAY)
    AND order_status = 'FULFILLED'
),
ArOrders_last_week AS (
  SELECT ar.order_code,
    CASE
      WHEN ar.status_desc = 'OffLineOrders' AND s.order_code IS NOT NULL THEN 'Success'
      WHEN ar.status_desc = 'Success' THEN 'Success'
      ELSE 'Failure'
    END AS State
  FROM "autorenew_order_analytics-eventname_none-prod" ar
  LEFT JOIN sales_last_week s ON ar.order_code = s.order_code
  WHERE ar.__time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '14' DAY)
    AND ar.__time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '14' DAY)
    AND ar.days_to_expiry <= 30
    AND CAST(TIME_FORMAT(__time,'HH','America/Los_Angeles') AS int) IN (0,1,6,7,8,9,15)
)
SELECT
  COUNT(CASE WHEN State = 'Success' THEN 1 END) AS last_week_same_hour_success_count
FROM ArOrders_last_week;


-- same hour 3 week before data
WITH sales_last_week AS (
  SELECT order_code FROM "pse-order-prod"
  WHERE __time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '21' DAY)
    AND __time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '21' DAY)
    AND order_status = 'FULFILLED'
),
ArOrders_last_week AS (
  SELECT ar.order_code,
    CASE
      WHEN ar.status_desc = 'OffLineOrders' AND s.order_code IS NOT NULL THEN 'Success'
      WHEN ar.status_desc = 'Success' THEN 'Success'
      ELSE 'Failure'
    END AS State
  FROM "autorenew_order_analytics-eventname_none-prod" ar
  LEFT JOIN sales_last_week s ON ar.order_code = s.order_code
  WHERE ar.__time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '21' DAY)
    AND ar.__time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '21' DAY)
    AND ar.days_to_expiry <= 30
    AND CAST(TIME_FORMAT(__time,'HH','America/Los_Angeles') AS int) IN (0,1,6,7,8,9,15)
)
SELECT
  COUNT(CASE WHEN State = 'Success' THEN 1 END) AS last_week_same_hour_success_count
FROM ArOrders_last_week;


-- same hour 4 week before data
WITH sales_last_week AS (
  SELECT order_code FROM "pse-order-prod"
  WHERE __time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '28' DAY)
    AND __time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '28' DAY)
    AND order_status = 'FULFILLED'
),
ArOrders_last_week AS (
  SELECT ar.order_code,
    CASE
      WHEN ar.status_desc = 'OffLineOrders' AND s.order_code IS NOT NULL THEN 'Success'
      WHEN ar.status_desc = 'Success' THEN 'Success'
      ELSE 'Failure'
    END AS State
  FROM "autorenew_order_analytics-eventname_none-prod" ar
  LEFT JOIN sales_last_week s ON ar.order_code = s.order_code
  WHERE ar.__time >= DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '1' HOUR - INTERVAL '28' DAY)
    AND ar.__time < DATE_TRUNC('hour', CURRENT_TIMESTAMP - INTERVAL '28' DAY)
    AND ar.days_to_expiry <= 30
    AND CAST(TIME_FORMAT(__time,'HH','America/Los_Angeles') AS int) IN (0,1,6,7,8,9,15)
)
SELECT
  COUNT(CASE WHEN State = 'Success' THEN 1 END) AS last_week_same_hour_success_count
FROM ArOrders_last_week;


(${Current hour AR count 1week ago} + ${Current hour AR count 2week ago} + ${Current hour AR count 3week ago} + ${Current hour AR count 4week ago})/4

$F * 0.80

${Current hour AR count} < $G